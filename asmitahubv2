-- asmitahub (rapi & deduplikasi) - diperbaiki infinite jump agar kompatibel mobile
-- Rayfield Loader
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services (dideklarasikan sekali)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

--// ðŸª„ Create Window
local Window = Rayfield:CreateWindow({
	Name = "asmita Script Hub | Adventure Game",
	LoadingTitle = "Loading asmita Hub ðŸ’¥",
	LoadingSubtitle = "by amrr",
	ConfigurationSaving = {
		Enabled = false,
		FolderName = nil,
		FileName = "asmita Hub"
	},
	Discord = {
		Enabled = false,
		Invite = "noinvitelink",
		RememberJoins = true
	},
	KeySystem = true,
	KeySettings = {
		Title = "asmita Hub Key",
		Subtitle = "Key System",
		Note = "Key ada di server Discord",
		FileName = "asmitaHubKey1",
		SaveKey = false,
		GrabKeyFromSite = false,
		Key = {"240424"}
	}
})

-----------------------------------------------------------
-- ðŸ  MAIN TAB
-----------------------------------------------------------
local MainTab = Window:CreateTab("ðŸ  Home", nil)

Rayfield:Notify({
	Title = "asmita Hub Loaded! âœ…",
	Content = "GUI berhasil dijalankan!",
	Duration = 5,
	Image = 13047715178,
})

-- Infinite Jump (diperbaiki untuk mobile & PC)
local infiniteJumpEnabled = false
_G.infinjump = false -- tetap sediakan global agar kompatibel dengan referensi lama
local jumpConn = nil

-- Buat handler JumpRequest satu kali (mendukung on-screen jump di mobile)
if not jumpConn then
	jumpConn = UIS.JumpRequest:Connect(function()
		if infiniteJumpEnabled then
			local plr = Players.LocalPlayer
			local char = plr.Character
			-- jika karakter belum ada, abaikan (JumpRequest akan dipicu lagi saat ada)
			if not char then return end
			local humanoid = char:FindFirstChildOfClass("Humanoid")
			if humanoid then
				-- paksa state Jumping agar bisa melakukan multi-jump
				humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
				-- sedikit jeda lalu set ke Seated agar state bisa di-reset untuk jump berikutnya
				task.delay(0.05, function()
					if humanoid and humanoid.Parent then
						pcall(function() humanoid:ChangeState(Enum.HumanoidStateType.Seated) end)
					end
				end)
			end
		end
	end)
end

MainTab:CreateButton({
	Name = "ðŸª‚ Infinite Jump Toggle",
	Callback = function()
		infiniteJumpEnabled = not infiniteJumpEnabled
		_G.infinjump = infiniteJumpEnabled

		if infiniteJumpEnabled then
			Rayfield:Notify({
				Title = "ðŸª‚ Infinite Jump",
				Content = "Infinite Jump Aktif! Tekan tombol lompat (Space / on-screen) untuk melompat di udara.",
				Duration = 4,
			})
		else
			Rayfield:Notify({
				Title = "ðŸª‚ Infinite Jump",
				Content = "Infinite Jump Dimatikan.",
				Duration = 3,
			})
		end
	end,
})

-- ðŸƒ WalkSpeed Slider
MainTab:CreateSlider({
	Name = "ðŸƒ WalkSpeed",
	Range = {16, 300},
	Increment = 1,
	Suffix = "Speed",
	CurrentValue = 16,
	Callback = function(Value)
		local char = Players.LocalPlayer.Character
		local humanoid = char and char:FindFirstChildOfClass("Humanoid")
		if humanoid then
			humanoid.WalkSpeed = Value
		end
	end,
})

-- ðŸ¦˜ JumpPower Slider
MainTab:CreateSlider({
	Name = "ðŸ¦˜ JumpPower",
	Range = {16, 300},
	Increment = 1,
	Suffix = "Power",
	CurrentValue = 50,
	Callback = function(Value)
		local char = Players.LocalPlayer.Character
		local humanoid = char and char:FindFirstChildOfClass("Humanoid")
		if humanoid then
			humanoid.JumpPower = Value
		end
	end,
})

-----------------------------------------------------------
-- ðŸ TELEPORT TAB (CP0 - CP15)
-----------------------------------------------------------
local TPTab = Window:CreateTab("ðŸ Teleports", nil)
local player = Players.LocalPlayer

-- Fungsi aman untuk mengambil checkpoint
local function getCheckpoint(name)
	local success, result = pcall(function()
		local cps = Workspace:WaitForChild("Checkpoints", 5)
		return cps and cps:FindFirstChild(name)
	end)
	return success and result or nil
end

-- Buat semua checkpoint CP0 sampai CP15
local checkpoints = {}
for i = 0, 15 do
	checkpoints[i] = getCheckpoint("CP" .. i)
end

-- Fungsi teleport
local function teleportTo(target, name)
	if not target then
		Rayfield:Notify({
			Title = "âš  Gagal Teleport",
			Content = name .. " tidak ditemukan di workspace!",
			Duration = 3,
		})
		return
	end
	local char = player.Character or player.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart")
	hrp.CFrame = target.CFrame + Vector3.new(0, 3, 0)
	Rayfield:Notify({
		Title = "âœ… Teleport Berhasil!",
		Content = "Kamu berpindah ke " .. name .. " ðŸ",
		Duration = 3,
	})
end

-- Tambahkan tombol teleport untuk CP0â€“CP15
for i = 0, 15 do
	TPTab:CreateButton({
		Name = "ðŸš© Checkpoint CP" .. i,
		Callback = function()
			teleportTo(checkpoints[i], "CP" .. i)
		end,
	})
end

-----------------------------------------------------------
-- ðŸª½ FLY TAB (PC & MOBILE COMPATIBLE)
-----------------------------------------------------------
local FlyTab = Window:CreateTab("ðŸª½ Fly", nil)
local flying = false
local flySpeed = 60
local flyConn = nil
local bodyVel, bodyGyro

-- Variabel kontrol mobile
local moveForward, moveBackward, moveLeft, moveRight, moveUp, moveDown =
	false, false, false, false, false, false

-- Deteksi platform
local isMobile = UIS.TouchEnabled and not UIS.KeyboardEnabled

local function stopFly(char)
	if bodyVel then bodyVel:Destroy() bodyVel = nil end
	if bodyGyro then bodyGyro:Destroy() bodyGyro = nil end
	if flyConn then flyConn:Disconnect() flyConn = nil end

	local humanoid = char and char:FindFirstChildOfClass("Humanoid")
	if humanoid then
		humanoid.PlatformStand = false
		pcall(function() humanoid:ChangeState(Enum.HumanoidStateType.Running) end)
	end

	moveForward, moveBackward, moveLeft, moveRight, moveUp, moveDown =
		false, false, false, false, false, false
end

local function startFly()
	local player = Players.LocalPlayer
	local char = player.Character or player.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart")
	local humanoid = char:WaitForChild("Humanoid")

	humanoid.PlatformStand = true

	bodyVel = Instance.new("BodyVelocity")
	bodyVel.MaxForce = Vector3.new(9e9, 9e9, 9e9)
	bodyVel.Velocity = Vector3.zero
	bodyVel.Parent = hrp

	bodyGyro = Instance.new("BodyGyro")
	bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
	bodyGyro.P = 9e4
	bodyGyro.CFrame = hrp.CFrame
	bodyGyro.Parent = hrp

	flyConn = RunService.RenderStepped:Connect(function()
		if not flying then return end

		local camCF = Workspace.CurrentCamera.CFrame
		local moveDir = Vector3.zero

		if UIS:IsKeyDown(Enum.KeyCode.W) or moveForward then
			moveDir += camCF.LookVector
		end
		if UIS:IsKeyDown(Enum.KeyCode.S) or moveBackward then
			moveDir -= camCF.LookVector
		end
		if UIS:IsKeyDown(Enum.KeyCode.A) or moveLeft then
			moveDir -= camCF.RightVector
		end
		if UIS:IsKeyDown(Enum.KeyCode.D) or moveRight then
			moveDir += camCF.RightVector
		end
		if UIS:IsKeyDown(Enum.KeyCode.Space) or moveUp then
			moveDir += Vector3.new(0, 1, 0)
		end
		if UIS:IsKeyDown(Enum.KeyCode.LeftControl) or moveDown then
			moveDir -= Vector3.new(0, 1, 0)
		end

		if moveDir.Magnitude > 0 then
			bodyVel.Velocity = moveDir.Unit * flySpeed
		else
			bodyVel.Velocity = Vector3.zero
		end
		bodyGyro.CFrame = camCF
	end)
end

-- Fungsi pembuatan kontrol mobile untuk fly
local function createMobileControls()
	local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
	if playerGui:FindFirstChild("FlyControlsGUI") then return end

	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "FlyControlsGUI"
	screenGui.ResetOnSpawn = false
	screenGui.Parent = playerGui

	local function createButton(text, position, callback)
		local button = Instance.new("TextButton")
		button.Size = UDim2.new(0, 70, 0, 70)
		button.Position = position
		button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
		button.BackgroundTransparency = 0.3
		button.BorderSizePixel = 2
		button.BorderColor3 = Color3.fromRGB(255, 255, 255)
		button.Text = text
		button.TextColor3 = Color3.fromRGB(255, 255, 255)
		button.TextSize = 24
		button.Font = Enum.Font.GothamBold
		button.Parent = screenGui

		local corner = Instance.new("UICorner")
		corner.CornerRadius = UDim.new(0, 12)
		corner.Parent = button

		button.InputBegan:Connect(function(input)
			if input.UserInputType == Enum.UserInputType.Touch then
				callback(true)
				button.BackgroundColor3 = Color3.fromRGB(80, 150, 255)
			end
		end)

		button.InputEnded:Connect(function(input)
			if input.UserInputType == Enum.UserInputType.Touch then
				callback(false)
				button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
			end
		end)

		return button
	end

	createButton("â–²", UDim2.new(0, 20, 0.7, -80), function(pressed) moveForward = pressed end)
	createButton("â–¼", UDim2.new(0, 20, 0.7, 0), function(pressed) moveBackward = pressed end)
	createButton("â—„", UDim2.new(0, -60, 0.7, -40), function(pressed) moveLeft = pressed end)
	createButton("â–º", UDim2.new(0, 100, 0.7, -40), function(pressed) moveRight = pressed end)
	createButton("â–²", UDim2.new(1, -90, 0.7, -80), function(pressed) moveUp = pressed end)
	createButton("â–¼", UDim2.new(1, -90, 0.7, 0), function(pressed) moveDown = pressed end)

	local infoLabel = Instance.new("TextLabel")
	infoLabel.Size = UDim2.new(0, 200, 0, 30)
	infoLabel.Position = UDim2.new(0.5, -100, 0.7, -120)
	infoLabel.BackgroundTransparency = 1
	infoLabel.Text = "ðŸª½ Fly Controls"
	infoLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	infoLabel.TextSize = 18
	infoLabel.Font = Enum.Font.GothamBold
	infoLabel.Parent = screenGui
end

local function removeMobileControls()
	local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
	local gui = playerGui:FindFirstChild("FlyControlsGUI")
	if gui then gui:Destroy() end
end

FlyTab:CreateButton({
	Name = "ðŸ•Š Toggle Fly (On/Off)",
	Callback = function()
		local player = Players.LocalPlayer
		local char = player.Character or player.CharacterAdded:Wait()

		flying = not flying
		if flying then
			startFly()
			if isMobile then createMobileControls() end
			local controls = isMobile and "Gunakan tombol on-screen untuk bergerak." or "Gunakan W, A, S, D untuk bergerak. Space = naik, Ctrl = turun."
			Rayfield:Notify({ Title = "ðŸ•Š Fly Aktif!", Content = controls, Duration = 4 })
		else
			stopFly(char)
			removeMobileControls()
			Rayfield:Notify({ Title = "ðŸª¶ Fly Dimatikan", Content = "Kamu kembali berjalan normal.", Duration = 3 })
		end
	end,
})

FlyTab:CreateSlider({
	Name = "âš¡ Fly Speed",
	Range = {10, 200},
	Increment = 5,
	Suffix = "Speed",
	CurrentValue = 60,
	Callback = function(Value)
		flySpeed = Value
	end,
})

FlyTab:CreateButton({
	Name = "â„¹ Platform Info",
	Callback = function()
		local platform = isMobile and "ðŸ“± Mobile" or "ðŸ’» PC"
		Rayfield:Notify({
			Title = "Platform Detected",
			Content = "Kamu menggunakan: " .. platform,
			Duration = 3,
		})
	end,
})

-----------------------------------------------------------
-- ðŸŽ¯ CAMERA LOCK TAB (Focus & Teleport in One Tab)
-----------------------------------------------------------
local LockTab = Window:CreateTab("ðŸŽ¯ Camera Lock", nil)
local Camera = Workspace.CurrentCamera

-- ðŸ”’ Variabel utama
local lockEnabled = false
local lockTarget = nil
local lockConn = nil
local smoothness = 0.2

local originalType = Camera.CameraType
local originalSubject = Camera.CameraSubject

-- Utility: list player names, find by name, find nearest
local function getPlayerNames()
	local names = {}
	for _, p in pairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			table.insert(names, p.Name)
		end
	end
	return names
end

local function findPlayerByName(name)
	for _, p in pairs(Players:GetPlayers()) do
		if p.Name == name then return p end
	end
	return nil
end

local function findNearestPlayer()
	local char = LocalPlayer.Character
	if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
	local myPos = char.HumanoidRootPart.Position
	local nearest, minDist = nil, math.huge
	for _, p in pairs(Players:GetPlayers()) do
		if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			local dist = (p.Character.HumanoidRootPart.Position - myPos).Magnitude
			if dist < minDist then
				minDist = dist
				nearest = p
			end
		end
	end
	return nearest
end

local function resetCamera()
	Camera.CameraType = Enum.CameraType.Custom
	local char = LocalPlayer.Character
	if char then
		local humanoid = char:FindFirstChildOfClass("Humanoid")
		if humanoid then Camera.CameraSubject = humanoid end
	end
end

local function stopLock()
	if lockConn then lockConn:Disconnect() lockConn = nil end
	lockEnabled = false
	lockTarget = nil
	resetCamera()
	Rayfield:Notify({ Title = "ðŸŽ¯ Lock Dimatikan", Content = "Kamera kembali normal.", Duration = 3 })
end

local function startLock(target)
	if not target or not target.Character then
		Rayfield:Notify({ Title = "âŒ Gagal", Content = "Target tidak ditemukan atau belum spawn.", Duration = 3 })
		return
	end
	lockTarget = target
	lockEnabled = true
	Camera.CameraType = Enum.CameraType.Scriptable
	Rayfield:Notify({ Title = "ðŸŽ¯ Lock Aktif", Content = "Kamera fokus pada " .. target.Name, Duration = 3 })

	lockConn = RunService.RenderStepped:Connect(function(dt)
		if not lockEnabled or not lockTarget or not lockTarget.Character then stopLock() return end
		local targetHead = lockTarget.Character:FindFirstChild("Head")
		if not targetHead then return end
		local targetPos = targetHead.Position + Vector3.new(0, 1, 0)
		local backOffset = Vector3.new(0, 4, 8)
		local desiredPos = targetHead.CFrame:ToWorldSpace(CFrame.new(backOffset)).p
		local currentCF = Camera.CFrame
		local desiredCF = CFrame.new(desiredPos, targetPos)
		Camera.CFrame = currentCF:Lerp(desiredCF, math.clamp(dt * (1 / smoothness), 0, 1))
	end)
end

local selectedName = nil
local dropdown = LockTab:CreateDropdown({
	Name = "ðŸ”Ž Pilih Pemain",
	Options = getPlayerNames(),
	CurrentOption = {},
	MultipleOptions = false,
	Callback = function(Option)
		selectedName = Option[1]
	end,
})

local function refreshDropdown()
	dropdown:Refresh(getPlayerNames())
end

Players.PlayerAdded:Connect(refreshDropdown)
Players.PlayerRemoving:Connect(refreshDropdown)

LockTab:CreateButton({
	Name = "ðŸŽ¯ Lock Player (Selected)",
	Callback = function()
		if lockEnabled then
			stopLock()
		else
			local p = findPlayerByName(selectedName)
			if p then startLock(p)
			else
				Rayfield:Notify({ Title = "âŒ Tidak Ditemukan", Content = "Pemain tidak valid atau belum dipilih.", Duration = 2 })
			end
		end
	end,
})

LockTab:CreateButton({
	Name = "ðŸŽ¯ Lock Nearest Player",
	Callback = function()
		if lockEnabled then
			stopLock()
		else
			local p = findNearestPlayer()
			if p then startLock(p)
			else Rayfield:Notify({ Title = "âš  Tidak Ada Pemain", Content = "Tidak ada pemain lain di dekatmu.", Duration = 2 }) end
		end
	end,
})

LockTab:CreateSlider({
	Name = "âš™ Smoothness",
	Range = {0.05, 1},
	Increment = 0.05,
	Suffix = "",
	CurrentValue = smoothness,
	Callback = function(Value)
		smoothness = Value
	end,
})

local function teleportToCamera()
	local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart")
	local camCF = Camera.CFrame
	hrp.CFrame = camCF + camCF.LookVector * -2 + Vector3.new(0, 3, 0)
	if lockEnabled then stopLock() else resetCamera() end
	Rayfield:Notify({ Title = "âš¡ Teleport Berhasil!", Content = "Kamu berpindah ke posisi kamera. Kamera kembali normal ðŸŽ¯", Duration = 3 })
end

LockTab:CreateButton({
	Name = "âš¡ Teleport ke Posisi Kamera",
	Callback = teleportToCamera,
})

LocalPlayer.CharacterRemoving:Connect(function() stopLock() end)
Players.PlayerRemoving:Connect(function(p) if lockTarget == p then stopLock() end end)

print("[asmita Hub] âœ… Loaded successfully - PC & Mobile Compatible!")
